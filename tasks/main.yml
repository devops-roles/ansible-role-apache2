---
# tasks file for hammadrauf.ansible-role-apache2
- name: Play - Create 2 Super Users 
  hosts: all
  vars_files:
    - ./vars/vars.yml
    - ./vars/secrets.yml
  become: true

  pre_tasks:
    - debug: var=ansible_os_family
    - name: Load OS specific Vars file
      include_vars: "{{ item }}"
      with_first_found:
        - "./vars/os_specific_{{ ansible_os_family }}.yml"
        - "./vars/os_specific_default.yml"    

  tasks:
    - name: Repeat createuser block with loop
      ansible.builtin.include_tasks: createuser.yml
        name: "{{ vmuser1 }}"
        password: "{{ vmpwd1 }}"
        create_home: true
        groups: "users,mail,{{ sudo_group }}"
        shell: /bin/bash
        expires: -1

    - name: Create .ssh folder for Super User 1
      file:
        path: "/home/{{ vmuser1 }}/.ssh"
        state: directory

    - name: Check if running from Vagrant or other method, by checking User vagrant folder
      stat: path=/home/vagrant
      register: st

    - name: Append user Public key to Authorized_keys for Super User 1
      shell: "cat /home/vagrant/.ssh/me.pub >> /home/{{ vmuser1 }}/.ssh/authorized_keys"
      args:
        creates: "/home/{{ vmuser1 }}/.ssh/authorized_keys"
      when: st.stat.exists

    - name: Copy user Public key to Authorized_keys for Super User 1
      shell: "cat /root/.ssh/authorized_keys >> /home/{{ vmuser1 }}/.ssh/authorized_keys"
      args:
        creates: "/home/{{ vmuser1 }}/.ssh/authorized_keys"
      when: not st.stat.exists

    - name: Add NOPASSWD Sudo into SUDOERS for Super User 1
      lineinfile:
        path: /etc/sudoers
        line: "{{ vmuser1 }}        ALL=(ALL)       NOPASSWD: ALL"
        validate: /usr/sbin/visudo -cf %s

    - name: Set Home directory ownership - Super User 1
      file:
        path: "/home/{{ vmuser1 }}"
        owner: "{{ vmuser1 }}"
        group: "{{ vmuser1 }}"
        recurse: true

    - name: Create Super User 2
      user:
        name: "{{ vmuser2 }}"
        password: "{{ vmpwd2 }}"
        create_home: true
        groups: "users,mail,{{ sudo_group }}"
        shell: /bin/bash
        expires: -1

    - name: Create .ssh folder for Super User 2
      file:
        path: "/home/{{ vmuser2 }}/.ssh"
        state: directory

    - name: Append user Public key to Authorized_keys for Super User 2
      shell: "cat /home/vagrant/.ssh/me.pub >> /home/{{ vmuser2 }}/.ssh/authorized_keys"
      args:
        creates: "/home/{{ vmuser2 }}/.ssh/authorized_keys"
      when: st.stat.exists        

    - name: Copy user Public key to Authorized_keys for Super User 2
      shell: "cat /root/.ssh/authorized_keys >> /home/{{ vmuser2 }}/.ssh/authorized_keys"
      args:
        creates: "/home/{{ vmuser2 }}/.ssh/authorized_keys"
      when: not st.stat.exists

    - name: Add NOPASSWD Sudo into SUDOERS for Super User 2
      lineinfile:
        path: /etc/sudoers
        line: "{{ vmuser2 }}        ALL=(ALL)       NOPASSWD: ALL"
        validate: /usr/sbin/visudo -cf %s

    - name: Set Home directory ownership - Super User 2
      file:
        path: "/home/{{ vmuser2 }}"
        owner: "{{ vmuser2 }}"
        group: "{{ vmuser2 }}"
        recurse: true

- name: Play - Install Apache
  hosts: all
  vars_files:
    - ./vars/vars.yml
    - ./vars/secrets.yml
  remote_user: "{{ vmuser1 }}"

  pre_tasks:
    - debug: var=ansible_os_family
    - name: Load OS specific Vars file
      include_vars: "{{ item }}"
      with_first_found:
        - "./vars/os_specific_{{ ansible_os_family }}.yml"
        - "./vars/os_specific_default.yml"

  tasks:
    - name: Install package Apache
      package:
        name: "{{ vapache }}"
        state: present
      become: true

    - name: Enable the Apache Service, if not already done so
      service: 
        name: "{{ vapache_service }}"
        enabled: true
      become: true

    - name: Start the Apache Service, if not already done so
      service: 
        name: "{{ vapache_service }}"
        state: started
      become: true

    - name: Check if Apache Default Content folder exists
      stat: path="{{ vapache_default_content }}"
      register: apc

    - name: Delete the pre-packeged files from Apache Default Content folder
      shell: "/usr/bin/rm -rf {{ vapache_default_content }}/* && /usr/bin/find {{ vapache_default_content }}/ -name '.*' ! -name '.' ! -name '..' -delete"
      args:
        removes: "{{ vapache_default_content }}/index.html"
      become: true
      when: apc.stat.exists
      
    - name: Copy the included index.html from Host to remote in the Apache Default Content folder
      copy:
        src: ./script-uploaded-files/index.html
        dest: "{{ vapache_default_content }}/index.html"
        owner: "{{ vapache_user }}"
        group: "{{ vapache_group }}"
        mode: '0644'
      become: true
      when: apc.stat.exists      

    - name: Copy the included site_styles.css from Host to remote in the Apache Default Content folder
      copy:
        src: ./script-uploaded-files/site_styles.css
        dest: "{{ vapache_default_content }}/site_styles.css"
        owner: "{{ vapache_user }}"
        group: "{{ vapache_group }}"
        mode: '0644'
      become: true
      when: apc.stat.exists

    - name: Copy the included icon from Host to remote in the Apache Default Content folder
      copy:
        src: ./script-uploaded-files/castle-icon.ico
        dest: "{{ vapache_default_content }}/favicon.ico"
        owner: "{{ vapache_user }}"
        group: "{{ vapache_group }}"
        mode: '0644'
      become: true
      when: apc.stat.exists

    - name: Re-Start the Apache Service.
      service: 
        name: "{{ vapache_service }}"
        state: restarted
      become: true
      when: apc.stat.exists

    - name: Gather the installed package facts
      ansible.builtin.package_facts:
        manager: auto      
      when: ansible_os_family == "RedHat"

    - name: If FirewallD is installed then open 'http' port
      ansible.posix.firewalld: 
        service: http
        permanent: true
        state: enabled
      become: true
      when:  ansible_os_family == "RedHat" and "'firewalld' in ansible_facts.packages"

    - name: Re-Start the Firewalld Service
      service: 
        name: "firewalld"
        state: restarted
      become: true
      when: ansible_os_family == "RedHat" and "'firewalld' in ansible_facts.packages"
